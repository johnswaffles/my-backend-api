<!-- Squarespace Code Block Start -->
<!-- AI Knowledge Assistant v1.0 - Clean & Sleek Update -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap"
    rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<div id="ai-assistant-app">
    <!-- Header -->
    <header class="ai-header">
        <div class="ai-brand">
            <span class="ai-logo-icon">‚ú¶</span>
            <span class="ai-title">Knowledge Assistant</span>
        </div>
        <div class="ai-controls">
            <button id="clear-history-btn" class="ai-icon-btn" title="Clear History">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main id="chat-container">
        <div id="welcome-screen" class="welcome-screen">
            <div class="welcome-icon">‚ú¶</div>
            <h2>How can I help you today?</h2>
            <p>Ask me anything. I can provide detailed answers, analyze images, and help you learn.</p>
        </div>
        <div id="chat-messages">
            <!-- Messages injected here -->
        </div>
    </main>

    <!-- Image Review Preview -->
    <div id="image-preview-area" class="image-preview-area" style="display: none;">
        <div class="preview-card">
            <img id="image-preview-img" src="" alt="Upload Preview">
            <button id="remove-image-btn" class="remove-image-btn">√ó</button>
        </div>
    </div>

    <!-- Input Area -->
    <footer class="ai-footer">
        <div class="input-wrapper">
            <button id="upload-btn" class="ai-icon-btn secondary" title="Upload Image">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" />
                </svg>
            </button>
            <input type="file" id="image-input" accept="image/*" style="display: none;">

            <textarea id="chat-input" placeholder="Ask a question..." rows="1"></textarea>

            <button id="send-btn" class="send-btn" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="send-icon">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </footer>
</div>

<style>
    /* Modern AI Theme */
    :root {
        --bg-app: #121212;
        --bg-panel: #1e1e1e;
        --bg-message-user: #2d2d2d;
        --bg-message-bot: transparent;
        --accent-primary: #3b82f6;
        /* Blue */
        --accent-glow: rgba(59, 130, 246, 0.5);
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --border-subtle: #374151;
        --font-main: 'Inter', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
    }

    /* Base Reset */
    #ai-assistant-app {
        font-family: var(--font-main);
        background: var(--bg-app);
        color: var(--text-main);
        width: 100%;
        max-width: 1000px;
        height: 700px;
        /* Or 100vh if preferred */
        margin: 0 auto;
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    #ai-assistant-app * {
        box-sizing: border-box;
    }

    /* Header */
    .ai-header {
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-subtle);
        background: var(--bg-panel);
    }

    .ai-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        letter-spacing: -0.02em;
    }

    .ai-logo-icon {
        color: var(--accent-primary);
        font-size: 1.2rem;
    }

    .ai-icon-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ai-icon-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-main);
    }

    /* Main Chat */
    #chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 40px;
        scroll-behavior: smooth;
        position: relative;
    }

    /* Welcome Screen */
    .welcome-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: var(--text-muted);
        opacity: 0.8;
    }

    .welcome-screen h2 {
        margin-bottom: 10px;
        color: var(--text-main);
    }

    .welcome-icon {
        font-size: 3rem;
        color: var(--border-subtle);
        margin-bottom: 20px;
    }

    /* Messages */
    .message {
        display: flex;
        flex-direction: column;
        margin-bottom: 32px;
        animation: fadeIn 0.3s ease-out;
    }

    .message.user {
        align-items: flex-end;
    }

    .message-bubble {
        max-width: 85%;
        padding: 12px 18px;
        border-radius: 12px;
        line-height: 1.6;
        font-size: 0.95rem;
    }

    .message.user .message-bubble {
        background: var(--bg-message-user);
        color: var(--text-main);
        border-bottom-right-radius: 2px;
    }

    .message.bot .message-bubble {
        background: var(--bg-message-bot);
        padding: 0;
        /* Remove padding for bot to align left perfectly */
        max-width: 100%;
        width: 100%;
    }

    /* Markdown Styling */
    .message-content h1,
    .message-content h2,
    .message-content h3 {
        margin-top: 24px;
        margin-bottom: 12px;
        font-weight: 600;
        color: #fff;
    }

    .message-content p {
        margin-bottom: 16px;
    }

    .message-content ul,
    .message-content ol {
        margin-bottom: 16px;
        padding-left: 24px;
    }

    .message-content li {
        margin-bottom: 8px;
    }

    .message-content code {
        font-family: var(--font-mono);
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
    }

    .message-content pre {
        background: #0d0d0d;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 16px;
        border: 1px solid var(--border-subtle);
    }

    .message-content pre code {
        background: transparent;
        padding: 0;
        color: #e5e7eb;
    }

    .message-content a {
        color: var(--accent-primary);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s;
    }

    .message-content a:hover {
        border-bottom-color: var(--accent-primary);
    }

    .attached-image {
        max-width: 300px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid var(--border-subtle);
    }

    /* Loading Indicator */
    .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: var(--text-muted);
        border-radius: 50%;
        margin-right: 4px;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* Follow-up Chips */
    .follow-up-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
    }

    .follow-up-chip {
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-muted);
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .follow-up-chip:hover {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        background: rgba(59, 130, 246, 0.05);
    }

    /* Play Audio Button */
    .audio-control-btn {
        margin-top: 8px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .audio-control-btn:hover {
        opacity: 1;
        color: var(--accent-primary);
    }

    /* Footer / Input */
    .ai-footer {
        padding: 20px 40px;
        background: var(--bg-panel);
        border-top: 1px solid var(--border-subtle);
    }

    .input-wrapper {
        background: var(--bg-app);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 8px 12px;
        display: flex;
        align-items: flex-end;
        gap: 10px;
        transition: border-color 0.2s;
    }

    .input-wrapper:focus-within {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    #chat-input {
        background: transparent;
        border: none;
        color: #fff;
        flex: 1;
        font-family: var(--font-main);
        font-size: 1rem;
        resize: none;
        max-height: 120px;
        padding: 10px 0;
        outline: none;
    }

    .send-btn {
        background: var(--accent-primary);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .send-btn:disabled {
        background: var(--border-subtle);
        color: var(--text-muted);
        cursor: not-allowed;
    }

    /* Image Preview */
    .image-preview-area {
        padding: 0 40px 10px;
        background: var(--bg-panel);
    }

    .preview-card {
        position: relative;
        display: inline-block;
    }

    .preview-card img {
        height: 60px;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
    }

    .remove-image-btn {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: white;
        border: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mobile */
    @media (max-width: 600px) {
        #ai-assistant-app {
            height: 100vh;
            border-radius: 0;
            border: none;
        }

        #chat-container {
            padding: 16px;
        }

        .ai-footer {
            padding: 12px 16px;
        }
    }
</style>

<script>
    (function () {
        const BACKEND_URL = 'https://my-backend-api-1niy.onrender.com';

        // --- State ---
        const state = {
            history: [],
            isSending: false,
            uploadedImage: null // Base64 string
        };

        // --- DOM Elements ---
        const els = {
            container: document.getElementById('chat-container'),
            messages: document.getElementById('chat-messages'),
            input: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            imageInput: document.getElementById('image-input'),
            imagePreviewArea: document.getElementById('image-preview-area'),
            imagePreviewImg: document.getElementById('image-preview-img'),
            removeImageBtn: document.getElementById('remove-image-btn'),
            welcomeScreen: document.getElementById('welcome-screen'),
            clearHistoryBtn: document.getElementById('clear-history-btn')
        };

        // --- Event Listeners ---
        els.sendBtn.addEventListener('click', () => sendMessage());

        els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            // Auto-resize
            els.input.style.height = 'auto';
            els.input.style.height = Math.min(els.input.scrollHeight, 120) + 'px';
        });

        els.input.addEventListener('input', () => {
            updateSendButton();
        });

        // Image Upload
        els.uploadBtn.addEventListener('click', () => els.imageInput.click());
        els.imageInput.addEventListener('change', handleImageUpload);
        els.removeImageBtn.addEventListener('click', clearImage);

        // Clear History
        els.clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Clear conversation history?')) {
                state.history = [];
                els.messages.innerHTML = '';
                els.welcomeScreen.style.display = 'flex';
            }
        });

        // --- Functions ---

        function updateSendButton() {
            els.sendBtn.disabled = !els.input.value.trim() && !state.uploadedImage;
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.uploadedImage = e.target.result; // Base64
                els.imagePreviewImg.src = state.uploadedImage;
                els.imagePreviewArea.style.display = 'block';
                updateSendButton();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            state.uploadedImage = null;
            els.imageInput.value = '';
            els.imagePreviewArea.style.display = 'none';
            updateSendButton();
        }

        async function sendMessage(text = null) {
            if (state.isSending) return;

            const msgText = text || els.input.value.trim();
            const msgImage = state.uploadedImage; // Capture current image

            if (!msgText && !msgImage) return;

            // UI Updates
            state.isSending = true;
            els.welcomeScreen.style.display = 'none';
            els.input.value = '';
            els.input.style.height = 'auto';
            clearImage(); // Clear preview after sending
            updateSendButton();

            // Render User Message
            addMessage({ text: msgText, image: msgImage, role: 'user' });

            // Add to history
            state.history.push({
                role: 'user',
                parts: msgImage ? [{ text: msgText }, { inline_data: { mime_type: "image/jpeg", data: msgImage.split(',')[1] } }] : [{ text: msgText }]
            });

            // Show Loading
            const loadingId = addLoadingIndicator();

            try {
                const response = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msgText,
                        history: state.history,
                        image: msgImage // Send image if present
                    })
                });

                removeLoadingIndicator(loadingId);

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                let replyText = data.reply;

                // Parse Follow-up JSON (It's at the end)
                let followUps = [];
                const jsonMatch = replyText.match(/```json\s*({[\s\S]*?})\s*```$/);

                if (jsonMatch) {
                    try {
                        const jsonBlock = JSON.parse(jsonMatch[1]);
                        if (jsonBlock.followUps) {
                            followUps = jsonBlock.followUps;
                            // Remove the JSON block from the display text
                            replyText = replyText.replace(jsonMatch[0], '').trim();
                        }
                    } catch (e) {
                        console.warn('Failed to parse follow-up JSON', e);
                    }
                }

                // Render Bot Message
                addMessage({ text: replyText, role: 'model', followUps });

                // Update History
                state.history.push({
                    role: 'model',
                    parts: [{ text: replyText }] // We store clean text without JSON usually, or with it? Let's store clean.
                });

            } catch (error) {
                removeLoadingIndicator(loadingId);
                addMessage({ text: `‚ö†Ô∏è Error: ${error.message}`, role: 'system' });
            } finally {
                state.isSending = false;
            }
        }

        function addMessage({ text, image, role, followUps }) {
            const div = document.createElement('div');
            div.className = `message ${role === 'model' ? 'bot' : 'user'}`;

            let html = `<div class="message-bubble">`;

            if (image) {
                html += `<img src="${image}" class="attached-image">`;
            }

            if (role === 'model') {
                html += `<div class="message-content">${marked.parse(text)}</div>`;

                // TTS Button
                html += `
                    <button class="audio-control-btn" data-text="${encodeURIComponent(text.substring(0, 500))}">
                       <span class="icon">üîä</span> Listen
                    </button>
                `;

                // Follow Ups
                if (followUps && followUps.length > 0) {
                    html += `<div class="follow-up-container">`;
                    followUps.forEach(q => {
                        html += `<button class="follow-up-chip">${q}</button>`;
                    });
                    html += `</div>`;
                }
            } else {
                // User message (plain text usually fine, but escape html)
                const safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html += `<div class="message-content">${safeText}</div>`;
            }

            html += `</div>`;
            div.innerHTML = html;

            els.messages.appendChild(div);
            scrollToBottom();

            // Attach Listeners for dynamic elements
            if (role === 'model') {
                // Follow up clicks
                const chips = div.querySelectorAll('.follow-up-chip');
                chips.forEach(chip => {
                    chip.addEventListener('click', () => sendMessage(chip.textContent));
                });

                // TTS clicks
                const ttsBtn = div.querySelector('.audio-control-btn');
                ttsBtn.addEventListener('click', (e) => playTTS(e.target.closest('button'), text));
            }
        }

        function addLoadingIndicator() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message bot';
            div.innerHTML = `
                <div class="message-bubble">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>`;
            els.messages.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            els.container.scrollTop = els.container.scrollHeight;
        }

        // --- TTS Logic (Simplified) ---
        async function playTTS(btn, text) {
            if (btn.classList.contains('playing')) {
                // Stop logic could be added here if we keep track of audio
                return;
            }

            btn.innerHTML = '‚è≥ Loading...';

            try {
                // Simple fetch to existing endpoint
                const cleanText = text.replace(/[#*`]/g, ''); // Strip basic markdown
                const response = await fetch(`${BACKEND_URL}/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: cleanText, voice: 'alloy' })
                });

                if (!response.ok) throw new Error('TTS Failed');

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);

                audio.onplay = () => {
                    btn.innerHTML = 'üîä Playing...';
                    btn.classList.add('playing');
                };
                audio.onended = () => {
                    btn.innerHTML = 'üîä Listen';
                    btn.classList.remove('playing');
                };
                audio.play();

            } catch (e) {
                console.error(e);
                btn.innerHTML = '‚ö†Ô∏è Error';
            }
        }

    })();
</script>